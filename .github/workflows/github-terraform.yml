name: CI/CD - Terraform - GitHub Provider

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  workflow_dispatch:
    inputs:
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
env:
  CONFIG_DIRECTORY: "terraform"
  TF_CLOUD_ORGANIZATION: "nathanjnorris-org"
  TF_API_TOKEN: "${{ secrets.HCP_TF_API_TOKEN }}"
  TF_WORKSPACE: "agentic-platform"
  TF_VERSION: "latest"
  TF_VAR_github_owner: '"${{ vars.GH_CONFIG_ORG }}"'
  TF_VAR_github_app_id: '"${{ vars.GH_CONFIG_APP_ID }}"'
  TF_VAR_github_app_installation_id: '"${{ vars.GH_CONFIG_INSTALLATION_ID }}"'
  TF_VAR_github_app_pem_file: '"${{ secrets.GH_CONFIG_PRIVATE_KEY }}"'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Validate Terraform Configuration
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -recursive
      
      - name: Terraform Init
        id: init
        run: terraform init -backend=false
      
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
      
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
      
      - name: Initialize TFLint
        run: tflint --init
      
      - name: Run TFLint
        id: tflint
        run: tflint --format compact --recursive
        continue-on-error: true
      
      - name: Comment Validation Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          INIT_OUTCOME: ${{ steps.init.outcome }}
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          TFLINT_OUTCOME: ${{ steps.tflint.outcome }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style \`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization \`${{ steps.init.outcome }}\`
            #### Terraform Validation \`${{ steps.validate.outcome }}\`
            #### TFLint \`${{ steps.tflint.outcome }}\`
            
            *Pusher: @${{ github.actor }}, Working Directory: \`${{ env.CONFIG_DIRECTORY }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Fail if validation failed
        if: steps.fmt.outcome == 'failure' || steps.init.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: |
          echo "::error::Validation failed. Please fix the errors above."
          exit 1

  # Job 2: Security Scanning with Checkov
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.CONFIG_DIRECTORY }}
          framework: terraform
          output_format: cli
          soft_fail: false # Fail the build on security violations
          download_external_modules: false
      
      - name: Comment Security Results on PR
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v8
        env:
          CHECKOV_OUTCOME: ${{ steps.checkov.outcome }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checkovOutcome = process.env.CHECKOV_OUTCOME;
            const output = `#### Security Scan (Checkov) \`${checkovOutcome}\`
            
            ${checkovOutcome === 'failure' ? 'Security issues found. Review workflow logs for details.' : 'No security issues found.'}
            
            *For details, see the workflow run logs.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 3: Terraform Plan
  terraform-cloud-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [validate, security]
    environment:
      name: github-admin-plan
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}
          speculative: true

      - uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: run
        ## run may fail, if so continue to output PR comment
        ## step.terraform-cloud-check-run-status will fail job after pr comment is created/updated.
        continue-on-error: true
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
          plan_only: true
          ## OPTIONAL: set your own message for run. A default message will be defined for you.
          ## Example:
          # message: "Triggered From GitHub Actions CI ${{ github.sha }}"

      - uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.3.2
        id: plan-output
        with:
          plan: ${{ steps.run.outputs.plan_id }}

      ## REQUIRED: Workflow permissions: `Read and write permissions`
      ## GITHUB_TOKEN is the built in token provided by GitHub Actions. It will need to be set to "permissive" in your repository settings
      ## More information can be found here: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/managing-github-actions-settings-for-a-repository#setting-the-permissions-of-the-github_token-for-your-repository
      - uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Retrieve existing bot comments for the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            })
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('HCP Terraform Plan Output')
            })
            const output = `#### HCP Terraform Plan Output
               \`\`\`\n
               Plan: ${{ steps.plan-output.outputs.add }} to add, ${{ steps.plan-output.outputs.change }} to change, ${{ steps.plan-output.outputs.destroy }} to destroy.
               \`\`\`
               [HCP Terraform Plan](${{ steps.run.outputs.run_link }})
               `
            // 3. If we have a comment, update it, otherwise create a new one
            if (botComment) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              })
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })
            }

        ## Check Run Status, if not planned_and_finished fail the job
      - id: terraform-cloud-check-run-status
        if: ${{ steps.run.outputs.run_status != 'planned_and_finished'}}
        run: |
          echo "HCP Terraform Run Failed or Requires Further Attention"
          echo "Run Status: '${{ steps.run.outputs.run_status }}'"
          echo "${{ steps.run.outputs.run_link }}"
          exit 1

  # Job 4: Terraform Apply (Production Deployment)
  terraform-cloud-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-cloud-plan
    environment:
      name: github-admin-apply
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_action == 'apply') ||
      (github.event_name == 'schedule')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}

      - name: Create apply run in Terraform Cloud
        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: create-run
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}

      - name: Terraform Apply
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
        id: apply
        if: ${{ fromJSON(steps.create-run.outputs.payload).data.attributes.actions.IsConfirmable }}
        with:
          run: ${{ steps.create-run.outputs.run_id }}
          comment: "Apply Run from GitHub Actions CI ${{ github.sha }}"