name: Terraform GitHub Provider - CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  workflow_dispatch:
    inputs:
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
env:
  TF_CLOUD_ORGANIZATION: "nathanjnorris-org"
  TF_API_TOKEN: "${{ secrets.HCP_TF_API_TOKEN }}"
  TF_WORKSPACE: "agentic-platform"
  TF_VERSION: "latest"
  CONFIG_DIRECTORY: "terraform"
  GITHUB_ORG: "nathlan"
  GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
  GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
  GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Validate Terraform Configuration
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.1.1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@d3ccb9bb9e8593f7e2e6e6c4d86c0163fb56a77d # v1.11.2
        with:
          app-id: ${{ vars.GH_CONFIG_APP_ID }}
          private-key: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
          owner: ${{ env.GITHUB_ORGANIZATION }}
      
      - name: Terraform Init
        id: init
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform init -backend=false
      
      - name: Terraform Validate
        id: validate
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform validate -no-color
      
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@da2d039c9afa1bd8f97e4ad9bc2e5bc31ed8d1c1 # v4.1.0
      
      - name: Initialize TFLint
        run: tflint --init
      
      - name: Run TFLint
        id: tflint
        run: tflint --format compact --recursive
        continue-on-error: true
      
      - name: Comment Validation Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          INIT_OUTCOME: ${{ steps.init.outcome }}
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          TFLINT_OUTCOME: ${{ steps.tflint.outcome }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### TFLint üîç\`${{ steps.tflint.outcome }}\`
            
            *Pusher: @${{ github.actor }}, Working Directory: \`${{ env.CONFIG_DIRECTORY }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Fail if validation failed
        if: steps.fmt.outcome == 'failure' || steps.init.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: |
          echo "::error::Validation failed. Please fix the errors above."
          exit 1

  # Job 2: Security Scanning with Checkov
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.1.1
      
      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@d25e9d386a2e2e8a4ae33bd2d2fa7f3b3e0c5e4a # v12.2897.0
        with:
          directory: ${{ env.CONFIG_DIRECTORY }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: false # Fail the build on security violations
          download_external_modules: false
          config_file: ${{ env.TF_WORKING_DIR }}/.checkov.yml
      
      - name: Upload Checkov SARIF results
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov
      
      - name: Comment Security Results on PR
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Security Scan (Checkov) üîí\`${{ steps.checkov.outcome }}\`
            
            ${steps.checkov.outcome === 'failure' ? '‚ö†Ô∏è Security issues found. Please review the SARIF results.' : '‚úÖ No security issues found.'}
            
            *Review security findings in the Security tab > Code scanning alerts*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 3: Terraform Plan
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [validate, security]
    environment:
      name: github-admin-plan
    defaults:
      run:
        working-directory: ${{ env.CONFIG_DIRECTORY }}
    outputs:
      plan_outcome: ${{ steps.plan.outcome }}
      has_changes: ${{ steps.plan.outputs.exitcode == '2' }}
    

      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: true
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@d3ccb9bb9e8593f7e2e6e6c4d86c0163fb56a77d # v1.11.2
        with:
          app-id: ${{ vars.GH_CONFIG_APP_ID }}
          private-key: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
          owner: ${{ env.GITHUB_ORGANIZATION }}
      
      - name: Terraform Init
        id: init
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform init
      
      - name: Terraform Plan
        id: plan
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: |
          terraform plan \
            -var="github_organization=${{ env.GITHUB_ORGANIZATION }}" \
            -out=tfplan \
            -detailed-exitcode \
            -no-color
        continue-on-error: true
      
      - name: Save Plan Output
        id: plan-output
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: |
          terraform show -no-color tfplan > plan_output.txt
      
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.4.3
        with:
          name: terraform-plan
          path: |
            ${{ env.CONFIG_DIRECTORY }}/github.tfplan
            ${{ env.CONFIG_DIRECTORY }}/.terraform.lock.hcl
          retention-days: 30
          if-no-files-found: error
      
      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN_EXITCODE: ${{ steps.plan.outputs.exitcode }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_output.txt', 'utf8');
            const planExitCode = process.env.PLAN_EXITCODE;
            
            let planStatus = '‚úÖ No changes';
            if (planExitCode === '1') {
              planStatus = '‚ùå Plan failed';
            } else if (planExitCode === '2') {
              planStatus = 'Changes detected';
              planOutput = fs.readFileSync('${{ env.CONFIG_DIRECTORY }}/plan_output.txt', 'utf8');
            } else {
              planOutput = fs.readFileSync('${{ env.CONFIG_DIRECTORY }}/plan_output.txt', 'utf8');
            }
            
            const output = `#### Terraform Plan ${planStatus}
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${planOutput.slice(0, 60000)}
            \`\`\`
            
            </details>`;
            }
            
            output += `
            
            *Pusher: @${{ github.actor }}, Working Directory: \`${{ env.CONFIG_DIRECTORY }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Fail if plan failed
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "::error::Terraform plan failed. Please review the errors above."
          exit 1
  terraform-cloud-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}
          speculative: true

      - uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: run
        ## run may fail, if so continue to output PR comment
        ## step.terraform-cloud-check-run-status will fail job after pr comment is created/updated.
        continue-on-error: true
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
          plan_only: true
          ## OPTIONAL: set your own message for run. A default message will be defined for you.
          ## Example:
          # message: "Triggered From GitHub Actions CI ${{ github.sha }}"

      - uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.3.2
        id: plan-output
        with:
          plan: ${{ steps.run.outputs.plan_id }}

      ## REQUIRED: Workflow permissions: `Read and write permissions`
      ## GITHUB_TOKEN is the built in token provided by GitHub Actions. It will need to be set to "permissive" in your repository settings
      ## More information can be found here: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/managing-github-actions-settings-for-a-repository#setting-the-permissions-of-the-github_token-for-your-repository
      - uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Retrieve existing bot comments for the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            })
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('HCP Terraform Plan Output')
            })
            const output = `#### HCP Terraform Plan Output
               \`\`\`\n
               Plan: ${{ steps.plan-output.outputs.add }} to add, ${{ steps.plan-output.outputs.change }} to change, ${{ steps.plan-output.outputs.destroy }} to destroy.
               \`\`\`
               [HCP Terraform Plan](${{ steps.run.outputs.run_link }})
               `
            // 3. If we have a comment, update it, otherwise create a new one
            if (botComment) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              })
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })
            }

        ## Check Run Status, if not planned_and_finished fail the job
      - id: terraform-cloud-check-run-status
        if: ${{ steps.run.outputs.run_status != 'planned_and_finished'}}
        run: |
          echo "HCP Terraform Run Failed or Requires Further Attention"
          echo "Run Status: '${{ steps.run.outputs.run_status }}'"
          echo "${{ steps.run.outputs.run_link }}"
          exit 1

  # Job 4: Terraform Apply (Production Deployment)
  apply:
    name: Apply to GitHub
    runs-on: ubuntu-latest
    needs: plan
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_action == 'apply') ||
      (github.event_name == 'schedule')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.1.1
      
          - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}

      - name: Create apply run in Terraform Cloud
        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: create-run
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}

      - name: Terraform Apply
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
        id: apply
        if: ${{ fromJSON(steps.create-run.outputs.payload).data.attributes.actions.IsConfirmable }}
        with:
          run: ${{ steps.create-run.outputs.run_id }}
          comment: "Apply Run from GitHub Actions CI ${{ github.sha }}"