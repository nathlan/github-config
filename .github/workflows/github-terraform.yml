name: CI/CD - Terraform - GitHub Provider

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/github-terraform.yml'
  workflow_dispatch:
    inputs:
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
  schedule:
    # Daily drift detection at 8 AM UTC
    - cron: '0 8 * * *'

env:
  TF_VERSION: '1.9.0'
  TF_WORKING_DIR: 'terraform'
  GITHUB_ORGANIZATION: 'nathlan'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Validate Terraform Configuration
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_CONFIG_APP_ID }}
          private-key: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
          owner: ${{ env.GITHUB_ORGANIZATION }}
          repositories: ${{ github.repository }}
      
      - name: Terraform Init
        id: init
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform init -backend=false
      
      - name: Terraform Validate
        id: validate
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform validate -no-color
      
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
      
      - name: Initialize TFLint
        run: tflint --init
      
      - name: Run TFLint
        id: tflint
        run: tflint --format compact --recursive
        continue-on-error: true
      
      - name: Comment Validation Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          INIT_OUTCOME: ${{ steps.init.outcome }}
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          TFLINT_OUTCOME: ${{ steps.tflint.outcome }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### TFLint üîç\`${{ steps.tflint.outcome }}\`
            
            *Pusher: @${{ github.actor }}, Working Directory: \`${{ env.TF_WORKING_DIR }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Fail if validation failed
        if: steps.fmt.outcome == 'failure' || steps.init.outcome == 'failure' || steps.validate.outcome == 'failure'
        run: |
          echo "::error::Validation failed. Please fix the errors above."
          exit 1

  # Job 2: Security Scanning with Checkov
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_WORKING_DIR }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: false # Fail the build on security violations
          download_external_modules: false
          config_file: ${{ env.TF_WORKING_DIR }}/.checkov.yml
      
      - name: Upload Checkov SARIF results
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov
      
      - name: Comment Security Results on PR
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Security Scan (Checkov) üîí\`${{ steps.checkov.outcome }}\`
            
            ${steps.checkov.outcome === 'failure' ? '‚ö†Ô∏è Security issues found. Please review the SARIF results.' : '‚úÖ No security issues found.'}
            
            *Review security findings in the Security tab > Code scanning alerts*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 3: Terraform Plan
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [validate, security]
    environment:
      name: github-admin-plan
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    outputs:
      plan_outcome: ${{ steps.plan.outcome }}
      has_changes: ${{ steps.plan.outputs.exitcode == '2' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: true
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_CONFIG_APP_ID }}
          private-key: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
          owner: ${{ env.GITHUB_ORGANIZATION }}
      
      - name: Terraform Init
        id: init
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform init
      
      - name: Terraform Plan
        id: plan
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: |
          terraform plan \
            -var="github_organization=${{ env.GITHUB_ORGANIZATION }}" \
            -out=tfplan \
            -detailed-exitcode \
            -no-color
        continue-on-error: true
      
      - name: Save Plan Output
        id: plan-output
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: |
          terraform show -no-color tfplan > plan_output.txt
      
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v6
        with:
          name: terraform-plan
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
            ${{ env.TF_WORKING_DIR }}/.terraform.lock.hcl
          retention-days: 30
          if-no-files-found: error
      
      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          PLAN_EXITCODE: ${{ steps.plan.outputs.exitcode }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_output.txt', 'utf8');
            const planExitCode = process.env.PLAN_EXITCODE;
            
            let planStatus = '‚úÖ No changes';
            if (planExitCode === '1') {
              planStatus = '‚ùå Plan failed';
            } else if (planExitCode === '2') {
              planStatus = 'üìù Changes detected';
            }
            
            const output = `#### Terraform Plan ${planStatus}
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${planOutput.slice(0, 60000)}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Working Directory: \`${{ env.TF_WORKING_DIR }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Fail if plan failed
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "::error::Terraform plan failed. Please review the errors above."
          exit 1

  # Job 4: Terraform Apply (Production Deployment)
  apply:
    name: Apply to GitHub
    runs-on: ubuntu-latest
    needs: plan
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.terraform_action == 'apply') ||
      (github.event_name == 'schedule')
    environment:
      name: github-admin
      url: https://github.com/${{ env.GITHUB_ORGANIZATION }}
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_CONFIG_APP_ID }}
          private-key: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
          owner: ${{ env.GITHUB_ORGANIZATION }}
      
      - name: Terraform Init
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: terraform init
      
      - name: Download Plan Artifact
        if: github.event_name != 'schedule'
        uses: actions/download-artifact@v7
        with:
          name: terraform-plan
          path: ${{ env.TF_WORKING_DIR }}
      
      - name: Terraform Apply
        id: apply
        env:
          GITHUB_APP_ID: ${{ vars.GH_CONFIG_APP_ID }}
          GITHUB_APP_INSTALLATION_ID: ${{ vars.GH_CONFIG_INSTALLATION_ID }}
          GITHUB_APP_PEM_FILE: ${{ secrets.GH_CONFIG_PRIVATE_KEY }}
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Running drift detection..."
            terraform plan \
              -var="github_organization=${{ env.GITHUB_ORGANIZATION }}" \
              -detailed-exitcode
          else
            echo "Applying saved plan..."
            terraform apply -auto-approve tfplan
          fi
      
      - name: Create Deployment Summary
        if: success() && github.event_name != 'schedule'
        run: |
          echo "## Terraform Apply Successful ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Organization:** ${{ env.GITHUB_ORGANIZATION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Working Directory:** ${{ env.TF_WORKING_DIR }}" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Version:** ${{ env.TF_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
      - name: Report Drift Detection
        if: github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const applyExitCode = '${{ steps.apply.outcome }}';
            
            if (applyExitCode === 'failure') {
              // Drift detected
              core.warning('‚ö†Ô∏è Drift detected in GitHub infrastructure!');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîç Drift Detected: GitHub Infrastructure - ${new Date().toISOString().split('T')[0]}`,
                body: `## Drift Detection Report
                
                Automated drift detection has identified changes in the GitHub infrastructure that differ from the Terraform state.
                
                **Organization:** ${{ env.GITHUB_ORGANIZATION }}
                **Detection Date:** ${new Date().toISOString()}
                **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                
                ### Next Steps
                1. Review the workflow logs to identify what has drifted
                2. Determine if the drift is expected or requires remediation
                3. Update Terraform configuration if the manual changes should be codified
                4. Or reapply Terraform to revert manual changes
                
                ### Common Causes
                - Manual changes made directly in GitHub UI
                - Changes made by other automation tools
                - Resources created/modified outside Terraform
                
                See [TROUBLESHOOTING.md](./docs/TROUBLESHOOTING.md) for more information.`,
                labels: ['drift-detection', 'terraform', 'infrastructure']
              });
            } else {
              core.info('‚úÖ No drift detected - infrastructure matches Terraform state');
            }

  # Job 5: Drift Detection Report (runs only on schedule)
  drift-summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: apply
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: Create Drift Summary
        run: |
          echo "## Daily Drift Detection üîç" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Organization:** ${{ env.GITHUB_ORGANIZATION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.apply.result }}" == "success" ]; then
            echo "‚úÖ **Status:** No drift detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Status:** Drift detected - Issue created" >> $GITHUB_STEP_SUMMARY
          fi
